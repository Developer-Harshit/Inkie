!function(e,t){"use strict";"function"==typeof define&&define.amd?define("seriously",function(){var i=t(e);return e.Seriously||(e.Seriously=i),i}):"object"==typeof exports?module.exports=t(e):"function"!=typeof e.Seriously&&(e.Seriously=t(e))}(window,function(e){"use strict";var t,i,r,n,s,o,u,h,a=e.document,f=e.console,c={},l={},d={},p={},$=[],m={},y={},g={canvas:[],image:[],video:[]},v={},x=e.WeakMap&&new WeakMap,_=0,E=function(){},T={transparent:[0,0,0,0],black:[0,0,0,1],red:[1,0,0,1],green:[0,128/255,0,1],blue:[0,0,1,1],white:[1,1,1,1],silver:[192/255,192/255,192/255,1],gray:[128/255,128/255,128/255,1],maroon:[128/255,0,0,1],purple:[128/255,0,128/255,1],fuchsia:[1,0,1,1],lime:[0,1,0,1],olive:[128/255,128/255,0,1],yellow:[1,1,0,1],navy:[0,0,128/255,1],teal:[0,128/255,128/255,1],aqua:[0,1,1,1],orange:[1,165/255,0,1]},b=/^(rgb|hsl)a?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*(\d+(\.\d*)?)\s*)?\)/i,w=/^#(([0-9a-fA-F]{3,8}))/,R=["x","y","z","w"],D=["r","g","b","a"],A={srcRGB:770,dstRGB:771,srcAlpha:1,dstAlpha:771},P=["MAX_COMBINED_TEXTURE_IMAGE_UNITS","MAX_FRAGMENT_UNIFORM_VECTORS","MAX_TEXTURE_IMAGE_UNITS","MAX_VARYING_VECTORS","MAX_VERTEX_ATTRIBS","MAX_VERTEX_TEXTURE_IMAGE_UNITS","MAX_VERTEX_UNIFORM_VECTORS"],S=/^[\t ]*#define[\t ]+SHADER_NAME\s+([^$\n\r]+)/i,B={frustum:function(e,t,i,r,n,s,o){o||(o=B.create());var u=t-e,h=r-i,a=s-n;return o[0]=2*n/u,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*n/h,o[6]=0,o[7]=0,o[8]=(t+e)/u,o[9]=(r+i)/h,o[10]=-(s+n)/a,o[11]=-1,o[12]=0,o[13]=0,o[14]=-(s*n*2)/a,o[15]=0,o},perspective:function(e,t,i,r,n){var s=i*Math.tan(e*Math.PI/360),o=s*t;return B.frustum(-o,o,-s,s,i,r,n)},multiply:function(e,t,i){var r=t[0],n=t[1],s=t[2],o=t[3],u=t[4],h=t[5],a=t[6],f=t[7],c=t[8],l=t[9],d=t[10],p=t[11],$=t[12],m=t[13],y=t[14],g=t[15],v=i[0],x=i[1],_=i[2],E=i[3];return e[0]=v*r+x*u+_*c+E*$,e[1]=v*n+x*h+_*l+E*m,e[2]=v*s+x*a+_*d+E*y,e[3]=v*o+x*f+_*p+E*g,v=i[4],x=i[5],_=i[6],E=i[7],e[4]=v*r+x*u+_*c+E*$,e[5]=v*n+x*h+_*l+E*m,e[6]=v*s+x*a+_*d+E*y,e[7]=v*o+x*f+_*p+E*g,v=i[8],x=i[9],_=i[10],E=i[11],e[8]=v*r+x*u+_*c+E*$,e[9]=v*n+x*h+_*l+E*m,e[10]=v*s+x*a+_*d+E*y,e[11]=v*o+x*f+_*p+E*g,v=i[12],x=i[13],_=i[14],E=i[15],e[12]=v*r+x*u+_*c+E*$,e[13]=v*n+x*h+_*l+E*m,e[14]=v*s+x*a+_*d+E*y,e[15]=v*o+x*f+_*p+E*g,e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}},F=(t=0,e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(i){var r,n,s;return n=Math.max(0,16-((r=new Date().getTime())-t)),s=e.setTimeout(function e(){i(r+n)},n),t=r+n,s}),U=e.cancelAnimationFrame||e.webkitCancelAnimationFrame||e.mozCancelAnimationFrame||e.oCancelAnimationFrame||e.msCancelAnimationFrame||function(t){e.cancelTimeout(t)},L=["alias","destroy","effect","id","initialize","inputs","isDestroyed","isReady","matte","off","on","readPixels","render","title","update"],C=["alias","destroy","id","inputs","isDestroyed","isReady","off","on","source","title","update"],O=["aliases","defaults","destroy","effect","go","id","incompatible","isDestroyed","isEffect","isNode","isSource","isTarget","isTransform","removeAlias","render","source","stop","target","transform"];function z(e,t){var i,r;if("string"==typeof e)i=a.querySelector(e);else if(!e)return!1;return(e.tagName&&(i=e),i)?(r=i.tagName.toLowerCase(),t&&0>t.indexOf(r))?e:i:e}function I(e,t){var i,r;for(i in e.prototype&&t.prototype&&e.prototype!==t.prototype&&I(e.prototype,t.prototype),t)t.hasOwnProperty(i)&&((r=Object.getOwnPropertyDescriptor(t,i)).get||r.set?Object.defineProperty(e,i,{configurable:!0,enumerable:!0,get:r.get,set:r.set}):e[i]=t[i]);return e}function N(e){var t;if(!f)return E;if("function"==typeof f[e])t=f[e];else{if("function"!=typeof f.log)return E;t=f.log}return t.bind?t.bind(f):function(){t.apply(f,arguments)}}function M(t,i){if(i||(i="HTMLElement"),t instanceof e[i])return!0;if(!t||"object"!=typeof t)return!1;for(;t;)if((t=Object.getPrototypeOf(t))&&t.constructor.name===i)return!0;return!1}function G(e,t,i,r,n){var s,o;function u(e,t,i){return((i%=1)<0&&(i+=1),i<1/6)?e+(t-e)*i*6:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e}return o=i<.5?i*(t+1):i+t-i*t,s=2*i-o,n||(n=[]),n[0]=u(s,o,e+1/3),n[1]=u(s,o,e),n[2]=u(s,o,e-1/3),n[3]=r,n}function k(e){var t,i,r,n="#",s=e[3]<1?4:3;for(t=0;t<s;t++)r=(i=Math.min(255,Math.round(255*e[t]||0))).toString(16),i<16&&(r="0"+r),n+=r;return n}function X(e){return Array.isArray(e)||e&&e.BYTES_PER_ELEMENT&&"length"in e}function W(t){if("function"!=typeof t)throw Error("setTimeoutZero argument is not a function");if($.push(t),"file:"===e.location.protocol){setTimeout(function e(){$.length&&$.shift()()},0);return}e.postMessage("seriously-timeout-message",e.location)}function V(t,i){var r;try{r=e.WebGLDebugUtils&&i&&i.debugContext?e.WebGLDebugUtils.makeDebugContext(t.getContext("webgl",i)):t.getContext("webgl",i)}catch(n){}if(!r)try{r=t.getContext("experimental-webgl",i)}catch(s){}return r}function H(){var t;return i&&i.getError()===i.CONTEXT_LOST_WEBGL&&(i=void 0),i||!e.WebGLRenderingContext||n||((i=V(t=a.createElement("canvas")))?t.addEventListener("webglcontextlost",function e(r){r.preventDefault(),i&&i.canvas===this&&(i=void 0,t.removeEventListener("webglcontextlost",e,!1))},!1):Z.logger.warn("Unable to access WebGL.")),i}function Y(e){var t,i,r;function n(e,r){var n,s;X(e)?(n=e[0],s=e[1]||n):n=e,"string"==typeof n?n=n.toLowerCase():"number"==typeof n?n=String(n):n||(n=""),i[n]=s,r||(t.firstValue=n)}function s(e){return e}for(r in e.inputs)if(e.inputs.hasOwnProperty(r)){if(e.reserved.indexOf(r)>=0||Object.prototype[r])throw Error("Reserved input name: "+r);(t=e.inputs[r]).name=r,isNaN(t.min)&&(t.min=-1/0),isNaN(t.max)&&(t.max=1/0),isNaN(t.minCount)&&(t.minCount=-1/0),isNaN(t.maxCount)&&(t.maxCount=1/0),isNaN(t.step)&&(t.step=0),isNaN(t.mod)&&(t.mod=0),"enum"===t.type&&t.options&&X(t.options)&&t.options.length&&(i={},t.options.forEach(n),t.options=i),"vector"===t.type?t.dimensions<2?t.dimensions=2:t.dimensions>4?t.dimensions=4:!t.dimensions||isNaN(t.dimensions)?t.dimensions=4:t.dimensions=Math.round(t.dimensions):t.dimensions=1,t.shaderDirty=!!t.shaderDirty,"function"!=typeof t.validate&&(t.validate=Z.inputValidators[t.type]||s),e.defaultImageInput||"image"!==t.type||(e.defaultImageInput=r)}}function j(e,t,i,r){var n,s,o,u,h=!0===r?r:r&&r.useFloat;h=!1,this.type=e.UNSIGNED_BYTE,n=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,n),r&&r.texture?(this.texture=r.texture,e.bindTexture(e.TEXTURE_2D,this.texture),this.ownTexture=!1):(this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this.ownTexture=!0);try{this.type===e.FLOAT?(o=new Float32Array(t*i*4),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.FLOAT,o)):(e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,null),this.type=e.UNSIGNED_BYTE)}catch(a){this.type=e.UNSIGNED_BYTE,o=new Uint8Array(t*i*4),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,o)}if(s=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,s),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,i),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,s),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture,0),(u=e.checkFramebufferStatus(e.FRAMEBUFFER))===e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT)throw Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");if(u===e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT)throw Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");if(u===e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS)throw Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");if(u===e.FRAMEBUFFER_UNSUPPORTED)throw Error("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");if(u!==e.FRAMEBUFFER_COMPLETE)throw Error("Incomplete framebuffer: "+u);e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),this.gl=e,this.frameBuffer=n,this.renderBuffer=s,this.width=t,this.height=i}function q(e,t,i){var r,n,s,o,u,h,a,f,c="";function l(t,i){var r,n;if(r=i?e.createShader(e.FRAGMENT_SHADER):e.createShader(e.VERTEX_SHADER),e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){for(n=0,t=t.split(/[\n\r]/);n<t.length;n++)t[n]=n+1+":	"+t[n];throw t.unshift("Error compiling "+(i?"fragment":"vertex")+" shader:"),Z.logger.error(t.join("\n")),Error("Shader error: "+e.getShaderInfoLog(r))}return r}function d(t,i){if(t.type===e.SAMPLER_2D)return function(r){t.glTexture=e["TEXTURE"+r],e.uniform1i(i,r)};if(t.type===e.BOOL||t.type===e.INT)return t.size>1?function(t){e.uniform1iv(i,t)}:function(t){e.uniform1i(i,t)};if(t.type===e.FLOAT)return t.size>1?function(t){e.uniform1fv(i,t)}:function(t){e.uniform1f(i,t)};if(t.type===e.FLOAT_VEC2)return function(t){e.uniform2f(i,t[0],t[1])};if(t.type===e.FLOAT_VEC3)return function(t){e.uniform3f(i,t[0],t[1],t[2])};if(t.type===e.FLOAT_VEC4)return function(t){e.uniform4f(i,t[0],t[1],t[2],t[3])};if(t.type===e.FLOAT_MAT3)return function(t){e.uniformMatrix3fv(i,!1,t)};if(t.type===e.FLOAT_MAT4)return function(t){e.uniformMatrix4fv(i,!1,t)};throw Error("Unknown shader uniform type: "+t.type)}function p(t){return function(){return e.getUniform(r,t)}}if(n=l(t),s=l(i,!0),r=e.createProgram(),e.attachShader(r,n),(o=e.getShaderInfoLog(n))&&(c+="Vertex shader error: "+o+"\n"),e.attachShader(r,s),(o=e.getShaderInfoLog(s))&&(c+="Fragment shader error: "+o+"\n"),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))throw c+=e.getProgramInfoLog(r),e.deleteProgram(r),e.deleteShader(n),e.deleteShader(s),(a=S.exec(t)||S.exec(i))&&(c="Shader = "+a[1]+"\n"+c),P.forEach(function(t){c+="\n"+t+": "+e.getParameter(e[t])}),Error("Could not initialize shader:\n"+c);for(e.useProgram(r),this.uniforms={},h=e.getProgramParameter(r,e.ACTIVE_UNIFORMS),u=0;u<h;++u)(f={info:e.getActiveUniform(r,u)}).name=f.info.name.replace(/\[0\]$/,""),f.loc=e.getUniformLocation(r,f.name),f.set=d(f.info,f.loc),f.get=p(f.loc),this.uniforms[f.name]=f,this[f.name]||(this[f.name]=f);for(u=0,this.attributes={},this.location={},h=e.getProgramParameter(r,e.ACTIVE_ATTRIBUTES);u<h;++u)(f={info:e.getActiveAttrib(r,u)}).name=f.info.name,f.location=e.getAttribLocation(r,f.name),this.attributes[f.name]=f,this.location[f.name]=f.location;this.gl=e,this.program=r,this.destroy=function(){var t;for(t in e&&(e.deleteProgram(r),e.deleteShader(n),e.deleteShader(s)),this)this.hasOwnProperty(t)&&delete this[t];r=null,n=null,s=null}}function Z(t){if(e===this||!(this instanceof Z)||void 0!==this.id)return new Z(t);var i,r,n,o,f,$,v,T,b,w,R,D,P,L,C,N=++_,G=this,X=[],H={},K=0,J=[],Q=[],ee=[],et=[],ei={},er=[],en=[],es={},eo={},eu=!1,eh=!1;function ea(e,t){var i,r,n;return!!t&&(i=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e.vertices,t.STATIC_DRAW),i.size=3,r=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.indices,t.STATIC_DRAW),n=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e.coords,t.STATIC_DRAW),n.size=2,{vertex:i,index:r,texCoord:n,length:e.indices.length,mode:e.mode||t.TRIANGLES})}function ef(e){var t={};return t.vertices=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0]),t.indices=new Uint16Array([0,1,2,0,2,3]),t.coords=new Float32Array([0,0,1,0,1,1,0,1]),ea(t,e)}function ec(e){var t,n;if(!r){if(e.canvas.addEventListener("webglcontextlost",ed,!1),e.canvas.addEventListener("webglcontextrestored",el,!1),e.isContextLost()){Z.logger.warn("Unable to attach lost WebGL context. Will try again when context is restored.");return}for(t=0,r=e,i=e.canvas,o=ef(r),f=new q(r,"#define SHADER_NAME seriously.base\n"+u,"#define SHADER_NAME seriously.base\n"+h);t<et.length;t++)(n=et[t]).gl=r,n.initialize(),n.buildShader();for(t=0;t<J.length;t++)(n=J[t]).initialize();for(t=0;t<Q.length;t++)(n=Q[t]).model||(n.model=o,n.shader=f)}}function el(){var e,t,i,s;if(n&&!r){if(M(t=n.target,"WebGLFramebuffer")){Z.logger.error("Unable to restore target built on WebGLFramebuffer");return}if(e=V(t,{alpha:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!0,debugContext:n.debugContext})){if(e.isContextLost()){Z.logger.error("Unable to restore WebGL Context");return}for(ec(e),n.renderToTexture?n.frameBuffer=new j(r,n.width,n.height,!1):n.frameBuffer={frameBuffer:null},i=0;i<X.length;i++)(s=X[i]).setDirty(),s.emit("webglcontextrestored");Z.logger.log("WebGL context restored")}}}function ed(e){var t,n;for(e&&(Z.logger.warn("WebGL context lost"),e.preventDefault()),C&&(U(C),C=0),i&&i.removeEventListener("webglcontextlost",ed,!1),t=0;t<et.length;t++)(n=et[t]).gl=null,n.initialized=!1,n.baseShader=null,n.model=null,n.frameBuffer=null,n.texture=null,n.shader&&n.shader.destroy&&(n.shader.destroy(),n.effect.commonShader&&delete eo[n.hook]),n.shaderDirty=!0,n.shader=null,n.effect.lostContext&&n.effect.lostContext.call(n),e&&n.emit("webglcontextlost");for(t=0;t<J.length;t++)(n=J[t]).texture=null,n.initialized=!1,n.allowRefresh=!1,e&&n.emit("webglcontextlost");for(t=0;t<ee.length;t++)(n=ee[t]).frameBuffer=null,n.texture=null,e&&n.emit("webglcontextlost");for(t=0;t<Q.length;t++)(n=Q[t]).model=!1,n.frameBuffer=null,e&&n.emit("webglcontextlost");f&&f.destroy&&f.destroy(),r&&(r.deleteBuffer(o.vertex),r.deleteBuffer(o.texCoord),r.deleteBuffer(o.index)),o&&(delete o.vertex,delete o.texCoord,delete o.index),o=null,f=null,r=null,i=null}function ep(e){var t,i,r=!1;if(C=0,er.length)for(t=0,r=!0;t<er.length;t++)er[t].call(G,e);if(J&&J.length)for(t=0,r=!0;t<J.length;t++)((i=J[t]).dirty||i.checkDirty&&i.checkDirty())&&(i.dirty=!1,i.setDirty());for(t=0;t<Q.length;t++)(i=Q[t]).auto&&i.dirty&&i.render();if(en.length)for(t=0,r=!0;t<en.length;t++)en[t].call(G);r&&!C&&(C=F(ep))}function e$(e,t,i,n,s,o){var u,h,a,f,c,l,d,p,$,m=0,y=s&&s.gl||r;if(y){for(u in s?(f=o&&o.width||s.width||y.canvas.width,c=o&&o.height||s.height||y.canvas.height):(f=o&&o.width||y.canvas.width,c=o&&o.height||y.canvas.height),e.use(),y.viewport(0,0,f,c),y.bindFramebuffer(y.FRAMEBUFFER,n),y.enableVertexAttribArray(e.location.position),y.enableVertexAttribArray(e.location.texCoord),t.texCoord&&(y.bindBuffer(y.ARRAY_BUFFER,t.texCoord),y.vertexAttribPointer(e.location.texCoord,t.texCoord.size,y.FLOAT,!1,0,0)),y.bindBuffer(y.ARRAY_BUFFER,t.vertex),y.vertexAttribPointer(e.location.position,t.vertex.size,y.FLOAT,!1,0,0),y.bindBuffer(y.ELEMENT_ARRAY_BUFFER,t.index),o&&o.depth?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),o?void 0===o.blend||o.blend?(r.enable(r.BLEND),l=void 0===o.srcRGB?r.ONE:o.srcRGB,p=o.dstRGB||r.ZERO,d=void 0===o.srcAlpha?l:o.srcAlpha,$=void 0===o.dstAlpha?p:o.dstAlpha,r.blendFuncSeparate(l,p,d,$),r.blendEquation(o.blendEquation||r.FUNC_ADD)):r.disable(r.BLEND):(r.enable(r.BLEND),r.blendFunc(r.ONE,r.ZERO),r.blendEquation(r.FUNC_ADD)),i)i.hasOwnProperty(u)&&(h=i[u],(a=e.uniforms[u])&&(M(h,"WebGLTexture")?(y.activeTexture(y.TEXTURE0+m),y.bindTexture(y.TEXTURE_2D,h),a.set(m),m++):h instanceof v||h instanceof T||h instanceof b?h.texture&&(y.activeTexture(y.TEXTURE0+m),y.bindTexture(y.TEXTURE_2D,h.texture),a.set(m),m++):null!=h&&a.set(h)));(!o||void 0===o.clear||o.clear)&&(y.clearColor(0,0,0,0),y.clear(y.COLOR_BUFFER_BIT|y.DEPTH_BUFFER_BIT)),y.drawElements(t.mode,t.length,y.UNSIGNED_SHORT,0),r.enable(r.DEPTH_TEST)}}function em(e,t,i){var r,n;if("string"==typeof e&&(t||0===t)||(i&&"object"==typeof i||(i=t),t=e),"string"==typeof e&&d[e]||(e=null),t instanceof v||t instanceof T||t instanceof b)r=t;else if(t instanceof R||t instanceof D||t instanceof P){if(!(r=H[t.id]))throw Error("Cannot connect a foreign node")}else{for("string"==typeof t&&isNaN(t)&&(t=z(t,["canvas","img","video"])),n=0;n<J.length;n++)if(r=J[n],(!e||e===r.hook)&&r.compare&&r.compare(t,i))return r;r=new v(e,t,i)}return r}function ey(e,t){var i,r,n;if(!(e instanceof T)&&!(e instanceof b))return!1;if(e===t)return!0;for(i in n=e.sources)if(n.hasOwnProperty(i)&&((r=n[i])===t||ey(r,t)))return!0;return!1}($=function(){this.ready=!1,this.width=1,this.height=1,this.gl=r,this.uniforms={resolution:[this.width,this.height],transform:null},this.dirty=!0,this.isDestroyed=!1,this.seriously=G,this.listeners={},this.id=K,K++}).prototype.setReady=function(){var e;if(!this.ready&&(this.ready=!0,this.emit("ready"),this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setReady()},$.prototype.setUnready=function(){var e;if(this.ready&&(this.ready=!1,this.emit("unready"),this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setUnready()},$.prototype.setDirty=function(){var e;if(!this.dirty&&(this.emit("dirty"),this.dirty=!0,this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setDirty()},$.prototype.initFrameBuffer=function(e){r&&(this.frameBuffer=new j(r,this.width,this.height,e))},$.prototype.readPixels=function(e,t,i,n,s){var o=this.gl||r;if(!r)throw Error("Cannot read pixels until a canvas is connected");if(this.frameBuffer||(this.initFrameBuffer(),this.setDirty()),this.render(),void 0===s)s=new Uint8Array(i*n*4);else if(!M(s,"Uint8Array"))throw Error("Incompatible array type");return o.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer.frameBuffer),o.readPixels(e,t,i,n,r.RGBA,r.UNSIGNED_BYTE,s),s},$.prototype.resize=function(){var e,t;this.source?(e=this.source.width,t=this.source.height):this.sources&&this.sources.source?(e=this.sources.source.width,t=this.sources.source.height):this.inputs&&this.inputs.width?(e=this.inputs.width,t=this.inputs.height||e):this.inputs&&this.inputs.height?e=t=this.inputs.height:(e=1,t=1),e=Math.floor(e),t=Math.floor(t),(this.width!==e||this.height!==t)&&(this.width=e,this.height=t,this.emit("resize"),this.setDirty()),this.uniforms&&this.uniforms.resolution&&(this.uniforms.resolution[0]=e,this.uniforms.resolution[1]=t),this.frameBuffer&&this.frameBuffer.resize&&this.frameBuffer.resize(e,t)},$.prototype.on=function(e,t){var i,r=-1;e&&"function"==typeof t&&((i=this.listeners[e])?r=i.indexOf(t):i=this.listeners[e]=[],r<0&&i.push(t))},$.prototype.off=function(e,t){var i,r=-1;e&&"function"==typeof t&&(i=this.listeners[e])&&(r=i.indexOf(t))>=0&&i.splice(r,1)},$.prototype.emit=function(e){var t,i=this.listeners[e];if(i&&i.length)for(t=0;t<i.length;t++)W(i[t])},$.prototype.destroy=function(){var e,t;for(t in delete this.gl,delete this.seriously,this.listeners)this.listeners.hasOwnProperty(t)&&delete this.listeners[t];for(e in this.uniforms)this.uniforms.hasOwnProperty(e)&&delete this.uniforms[e];this.targets&&delete this.targets,this.frameBuffer&&this.frameBuffer.destroy&&(this.frameBuffer.destroy(),delete this.frameBuffer),(e=X.indexOf(this))>=0&&X.splice(e,1),delete H[this.id],this.isDestroyed=!0},R=function(e){var t,i=e;function r(e,t){var r,n,s,o,u;return(s=i.effect.inputs[e],r=i.inputElements[e],"string"==typeof t&&isNaN(t)&&("enum"===s.type?s.options.hasOwnProperty(t)||(t=z(t,["select"])):"number"===s.type||"boolean"===s.type?t=z(t,["input","select"]):"image"===s.type&&(t=z(t,["canvas","img","video"]))),M(t,"HTMLInputElement")||M(t,"HTMLSelectElement"))?(n=t.value,r&&r.element!==t&&(r.element.removeEventListener("change",r.listener,!0),r.element.removeEventListener("input",r.listener,!0),delete i.inputElements[e],r=null),!r&&(r={element:t,listener:(o=e,u=t,function(){var e,r;e="checkbox"===t.type?t.checked:u.value,r=i.setInput(o,e),"color"===s.type&&(r=k(r).substr(0,7)),r!==e&&(u.value=r)})},i.inputElements[e]=r,"range"===t.type&&t.addEventListener("input",r.listener,!0),t.addEventListener("change",r.listener,!0)),r&&"checkbox"===t.type&&(n=t.checked)):(r&&(r.element.removeEventListener("change",r.listener,!0),r.element.removeEventListener("input",r.listener,!0),delete i.inputElements[e]),n=t),i.setInput(e,n),i.inputs[e]}function n(e){return function(t){var i=r(e,t);return i&&i.pub}}function s(e){return function(){var t=i.inputs[e];return t&&t.pub}}function o(e){return function(t){return r(e,t)}}function u(e){return function(){return i.inputs[e]}}for(t in i.effect.inputs)if(i.effect.inputs.hasOwnProperty(t)){if(void 0===this[t])"image"===i.effect.inputs[t].type?Object.defineProperty(this,t,{configurable:!0,enumerable:!0,get:s(t),set:n(t)}):Object.defineProperty(this,t,{configurable:!0,enumerable:!0,get:u(t),set:o(t)});else throw Error("Cannot overwrite Seriously."+t)}Object.defineProperties(this,{effect:{enumerable:!0,configurable:!0,get:function(){return i.hook}},title:{enumerable:!0,configurable:!0,get:function(){return i.effect.title||i.hook}},width:{enumerable:!0,configurable:!0,get:function(){return i.width}},height:{enumerable:!0,configurable:!0,get:function(){return i.height}},id:{enumerable:!0,configurable:!0,get:function(){return i.id}}}),this.render=function(){return i.render(),this},this.readPixels=function(e,t,r,n,s){return i.readPixels(e,t,r,n,s)},this.on=function(e,t){i.on(e,t)},this.off=function(e,t){i.off(e,t)},this.inputs=function(e){var t,r,n,s;if(n=i.effect.inputs,e)return(r=n[e])?(t={type:r.type,defaultValue:r.defaultValue,title:r.title||e},"number"===r.type?(t.min=r.min,t.max=r.max,t.step=r.step,t.mod=r.mod):"enum"===r.type?t.options=I({},r.options):"vector"===r.type&&(t.dimensions=r.dimensions),r.description&&(t.description=r.description),t):null;for(s in t={},n)n.hasOwnProperty(s)&&(t[s]=this.inputs(s));return t},this.alias=function(e,t){return i.alias(e,t),this},this.matte=function(e){i.matte(e)},this.destroy=function(){var e,t;for(e in i.destroy(),this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((t=Object.getOwnPropertyDescriptor(this,e)).get||t.set||"function"!=typeof this[e]?delete this[e]:this[e]=E)},this.isDestroyed=function(){return i.isDestroyed},this.isReady=function(){return i.ready}},(T=function(e,t){var i,n,o,u,h={};for(i in $.call(this,t),this.gl=r,this.effectRef=c[e],this.sources={},this.targets=[],this.inputElements={},this.dirty=!0,this.shaderDirty=!0,this.hook=e,this.options=t,this.transform=null,this.effect=I({},this.effectRef),this.effectRef.definition&&I(this.effect,this.effectRef.definition.call(this,t)),Y(this.effect),this.uniforms.transform=s,this.inputs={},u=es[e],this.effect.inputs)this.effect.inputs.hasOwnProperty(i)&&((void 0===(n=this.effect.inputs[i]).defaultValue||null===n.defaultValue)&&("number"===n.type?n.defaultValue=Math.min(Math.max(0,n.min),n.max):"color"===n.type?n.defaultValue=[0,0,0,0]:"boolean"===n.type?n.defaultValue=!1:"string"===n.type?n.defaultValue="":"enum"===n.type&&(n.defaultValue=n.firstValue)),o=n.validate.call(this,n.defaultValue,n),u&&void 0!==u[i]&&(o=n.validate.call(this,u[i],n,n.defaultValue,o),u[i]=o,"image"===n.type&&(h[i]=o)),this.inputs[i]=o,n.uniform&&(this.uniforms[n.uniform]=n.defaultValue));for(i in r&&(this.initialize(),this.effect.commonShader&&this.buildShader()),this.updateReady(),this.inPlace=this.effect.inPlace,this.pub=new R(this),X.push(this),H[this.id]=this,et.push(this),m[e].push(this),h)h.hasOwnProperty(i)&&this.setInput(i,h[i])}).prototype=Object.create($.prototype),T.prototype.constructor=T,T.prototype.initialize=function(){if(!this.initialized){var e=this;this.baseShader=f,this.shape?this.model=ea(this.shape,this.gl):this.model=o,"function"==typeof this.effect.initialize?this.effect.initialize.call(this,function(){e.initFrameBuffer(!0)},r):this.initFrameBuffer(!0),this.frameBuffer&&(this.texture=this.frameBuffer.texture),this.initialized=!0}},T.prototype.resize=function(){var e;for($.prototype.resize.call(this),this.effect.resize&&this.effect.resize.call(this),e=0;e<this.targets.length;e++)this.targets[e].resize()},T.prototype.updateReady=function(){var e,t,i,r,n,s=!0;for(i in(r=this.effect).inputs)if(r.inputs.hasOwnProperty(i)&&"image"===(t=this.effect.inputs[i]).type&&(!this.sources[i]||!this.sources[i].ready)&&(!r.requires||r.requires.call(this,i,this.inputs))){s=!1;break}if(this.ready!==s&&(this.ready=s,this.emit(s?"ready":"unready"),n=s?"setReady":"setUnready",this.targets))for(e=0;e<this.targets.length;e++)this.targets[e][n]()},T.prototype.setReady=T.prototype.updateReady,T.prototype.setUnready=T.prototype.updateReady,T.prototype.addTarget=function(e){var t;for(t=0;t<this.targets.length;t++)if(this.targets[t]===e)return;this.targets.push(e)},T.prototype.removeTarget=function(e){var t=this.targets&&this.targets.indexOf(e);t>=0&&this.targets.splice(t,1)},T.prototype.removeSource=function(e){var t,i=e&&e.pub;for(t in this.inputs)this.inputs.hasOwnProperty(t)&&(this.inputs[t]===e||this.inputs[t]===i)&&(this.inputs[t]=null);for(t in this.sources)this.sources.hasOwnProperty(t)&&(this.sources[t]===e||this.sources[t]===i)&&(this.sources[t]=null)},T.prototype.buildShader=function(){var e,t=this.effect,i=this;function n(e){return S.test(e)?e:"#define SHADER_NAME seriously."+i.hook+"\n"+e}this.shaderDirty&&(t.commonShader&&eo[this.hook]?(!this.shader&&eo[this.hook].count++,this.shader=eo[this.hook].shader):t.shader?(this.shader&&!t.commonShader&&this.shader.destroy(),(e=t.shader.call(this,this.inputs,{vertex:u,fragment:h},Z.util))instanceof q?this.shader=e:e&&e.vertex&&e.fragment?this.shader=new q(r,n(e.vertex),n(e.fragment)):this.shader=f,t.commonShader&&(eo[this.hook]={count:1,shader:this.shader})):this.shader=f,this.shaderDirty=!1)},T.prototype.render=function(){var e,t,i,n=this.effect,s=this;if(r){if(this.initialized||this.initialize(),this.shaderDirty&&this.buildShader(),this.dirty&&this.ready){for(e in this.sources)this.sources.hasOwnProperty(e)&&(!n.requires||n.requires.call(this,e,this.inputs))&&(i="function"==typeof this.inPlace?this.inPlace(e):this.inPlace,this.sources[e].render(!i));this.frameBuffer&&(t=this.frameBuffer.frameBuffer),"function"==typeof n.draw?(n.draw.call(this,this.shader,this.model,this.uniforms,t,function e(t,i,r,n,o,u){e$(t,i,r,n,o||s,u)}),this.emit("render")):t&&(e$(this.shader,this.model,this.uniforms,t,this),this.emit("render")),this.dirty=!1}return this.texture}},T.prototype.setInput=function(e,t){var i,r,n,o,u,h=this;if(this.effect.inputs.hasOwnProperty(e)){if("image"===(i=this.effect.inputs[e]).type){if(t){if((t=em(t))!==this.sources[e]){if(function t(){var i,r=h.sources[e];if(r){for(i in h.sources)if(i!==e&&h.sources.hasOwnProperty(i)&&h.sources[i]===r)return;r.removeTarget(h)}}(),ey(t,this))throw Error("Attempt to make cyclical connection.");this.sources[e]=t,t.addTarget(this)}}else delete this.sources[e],t=!1;r=this.sources[e],n=Object.keys(this.sources),!0===this.inPlace&&1===n.length?(o=this.sources[n[0]],this.uniforms.transform=o&&o.cumulativeMatrix||s):this.uniforms.transform=s}else u=es[this.hook]&&void 0!==es[this.hook][e]?es[this.hook][e]:i.defaultValue,r=t=i.validate.call(this,t,i,u,this.inputs[e]);return this.inputs[e]===t&&"color"!==i.type&&"vector"!==i.type||(this.inputs[e]=t,i.uniform&&(this.uniforms[i.uniform]=r),"image"===i.type?(this.resize(),this.updateReady()):i.updateSources&&this.updateReady(),i.shaderDirty&&(this.shaderDirty=!0),this.setDirty(),i.update&&i.update.call(this,t)),t}},T.prototype.alias=function(e,t){var i=this;if(O.indexOf(t)>=0)throw Error("'"+t+"' is a reserved name and cannot be used as an alias.");return this.effect.inputs.hasOwnProperty(e)&&(t||(t=e),G.removeAlias(t),ei[t]={node:this,input:e},Object.defineProperty(G,t,{configurable:!0,enumerable:!0,get:function(){return i.inputs[e]},set:function(t){return i.setInput(e,t)}})),this},T.prototype.matte=function(e){var t,i,r,n,s,o,u,h,a=[],f=[],c={};function l(e,t,i,r){var n,s,o,u,h;return n=(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x),s=(t.x-e.x)*(e.y-i.y)-(t.y-e.y)*(e.x-i.x),!!(o=(r.y-i.y)*(t.x-e.x)-(r.x-i.x)*(t.y-e.y))&&(u=n/o,h=s/o,u>0&&u<=1&&h>0&&h<=1)&&{x:e.x+u*(t.x-e.x),y:e.y+u*(t.y-e.y)}}function d(e){var t,i,r,n,s,o,u,h,c,d,p,$=[];if(!e.simple){for(t=0;t<e.edges.length;t++)for(r=e.edges[t],i=t+1;i<e.edges.length;i++)n=e.edges[i],(s=l(r[0],r[1],n[0],n[1]))&&(s.edge1=r,s.edge2=n,$.push(s));if($.length){for(t=0,c=[];t<$.length;t++)r=(s=$[t]).edge1,n=s.edge2,d={x:s.x,y:s.y,prev:r[0],next:n[1],id:f.length},e.vertices.push(d),f.push(d),p={x:s.x,y:s.y,prev:n[0],next:r[1],id:f.length},e.vertices.push(p),f.push(d),d.prev.next=d,d.next.prev=d,p.prev.next=p,p.next.prev=p;do{o={edges:[],vertices:[],simple:!0},c.push(o),u=h=e.vertices[0];do t=e.vertices.indexOf(h),e.vertices.splice(t,1),o.edges.push([h,h.next]),o.vertices.push(h),h=h.next;while(h!==u)}while(e.vertices.length);for(t=a.indexOf(e),a.splice(t,1),t=0;t<c.length;t++)a.push(c[t])}else e.simple=!0}}function p(e){var t,i,r,n,s=e.vertices.length,o=0;for(t=s-1,i=0;i<s;t=i,i++)r=e.vertices[t],n=e.vertices[i],o+=r.x*n.y-n.x*r.y;return o>0}function $(e){var t,i,n,s,o,u,h,a,f,c,l,d,p=e.vertices,$=[],m=[];function y(e,t,i,r){var n,s,o,u,h,a,f,c,l,d,p,$,m,y,g;return n=i.x-t.x,s=i.y-t.y,o=e.x-i.x,u=e.y-i.y,h=t.x-e.x,a=t.y-e.y,f=r.x-e.x,c=r.y-e.y,l=r.x-t.x,d=r.y-t.y,p=r.x-i.x,$=r.y-i.y,g=n*d-s*l,m=h*c-a*f,y=o*$-u*p,g>=0&&y>=0&&m>=0}function g(e,t,i,r,n){var s,o,u,h,a;if(o=p[n[e]],u=p[n[t]],h=p[n[i]],0>(u.x-o.x)*(h.y-o.y)-(u.y-o.y)*(h.x-o.x))return!1;for(s=0;s<r;s++)if(!(s===e||s===t||s===i)&&y(o,u,h,a=p[n[s]]))return!1;return!0}if(i=p.length,e.clockWise)for(t=0;t<i;t++)$[t]=t;else for(t=0;t<i;t++)$[t]=i-1-t;for(s=2*(n=i),o=0,t=n-1;n>2;){if(s--<=0)return m;if(n<=(u=t)&&(u=0),n<=(t=u+1)&&(t=0),n<(h=t+1)&&(h=0),g(u,t,h,n,$)){for(a=$[u],f=$[t],c=$[h],e.clockWise?(m.push(p[a]),m.push(p[f]),m.push(p[c])):(m.push(p[c]),m.push(p[f]),m.push(p[a])),o++,l=t,d=t+1;d<n;l++,d++)$[l]=$[d];s=2*--n}}r.indices=m}for(n=0,i=(t=e)&&t.length&&Array.isArray(t)?!Array.isArray(t[0])||Array.isArray(t[0])&&!isNaN(t[0][0])?[t]:t:[];n<i.length;n++){for(s=0,e=i[n],h=null,r={vertices:[],edges:[]};s<e.length;s++)"object"!=typeof(o=e[s])||isNaN(o.x)||isNaN(o.y)?!(o.length>=2)||isNaN(o[0])||isNaN(o[1])||(u={x:o[0],y:o[1],id:f.length}):u={x:o.x,y:o.y,id:f.length},u&&(h?(h.next=u,u.prev=h,u.next=r.vertices[0],r.vertices[0].prev=u):(r.head=u,u.next=u,u.prev=u),f.push(u),r.vertices.push(u),h=u);if(r.vertices.length>2)for(3===r.vertices.length&&(r.simple=!0),a.push(r),s=0;s<r.vertices.length;s++)u=r.vertices[s],r.edges.push([u,u.next])}for(n=a.length-1;n>=0;n--)d(r=a[n]);for(n=0;n<a.length;n++)(r=a[n]).clockWise=p(r),$(r);for(n=0,c.vertices=[],c.coords=[];n<f.length;n++)o=f[n],c.vertices.push(2*o.x-1),c.vertices.push(-2*o.y+1),c.vertices.push(-1),c.coords.push(o.x),c.coords.push(-1*o.y+1);for(n=0,c.vertices=new Float32Array(c.vertices),c.coords=new Float32Array(c.coords),c.indices=[];n<a.length;n++)for(s=0,r=a[n];s<r.indices.length;s++)o=r.indices[s],c.indices.push(o.id);c.indices=new Uint16Array(c.indices),this.shape=c,this.gl&&ea(c,this.gl)},T.prototype.destroy=function(){var e,t,i,r=this.hook;for(t in this.effect.destroy&&"function"==typeof this.effect.destroy&&this.effect.destroy.call(this),delete this.effect,eo[r]&&(eo[r].count--,eo[r].count||delete eo[r]),this.shader&&this.shader.destroy&&this.shader!==f&&!eo[r]&&this.shader.destroy(),delete this.shader,this.inputElements)this.inputElements.hasOwnProperty(t)&&((i=this.inputElements[t]).element.removeEventListener("change",i.listener,!0),i.element.removeEventListener("input",i.listener,!0));for(t in this.sources)this.sources.hasOwnProperty(t)&&((i=this.sources[t])&&i.removeTarget&&i.removeTarget(this),delete this.sources[t]);for(;this.targets.length;)(i=this.targets.pop())&&i.removeSource&&i.removeSource(this);for(t in this)this.hasOwnProperty(t)&&"id"!==t&&delete this[t];for(t in ei)ei.hasOwnProperty(t)&&(i=ei[t]).node===this&&G.removeAlias(t);(e=et.indexOf(this))>=0&&et.splice(e,1),(e=m[r].indexOf(this))>=0&&m[r].splice(e,1),$.prototype.destroy.call(this)},D=function(e){var t=e;Object.defineProperties(this,{original:{enumerable:!0,configurable:!0,get:function(){return t.source}},id:{enumerable:!0,configurable:!0,get:function(){return t.id}},width:{enumerable:!0,configurable:!0,get:function(){return t.width}},height:{enumerable:!0,configurable:!0,get:function(){return t.height}}}),this.render=function(){t.render()},this.update=function(){t.setDirty()},this.readPixels=function(e,i,r,n,s){return t.readPixels(e,i,r,n,s)},this.on=function(e,i){t.on(e,i)},this.off=function(e,i){t.off(e,i)},this.destroy=function(){var e,i;for(e in t.destroy(),this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((i=Object.getOwnPropertyDescriptor(this,e)).get||i.set||"function"!=typeof this[e]?delete this[e]:this[e]=E)},this.isDestroyed=function(){return t.isDestroyed},this.isReady=function(){return t.ready}},(v=function(e,t,i){var n,s,o=i||{},u=void 0===o.flip||o.flip,h=o.width,a=o.height,f=!1,c=this,l=!1;function p(e,t,i,r){var n=d[e];if(n.definition){if(!(n=n.definition.call(c,t,i,r)))return null;n=I(I({},d[e]),n)}return n}function m(e){return c.source===e}if($.call(this),(e&&"string"!=typeof e||!t&&0!==t)&&(i&&"object"==typeof i||(i=t),t=e),"string"==typeof t&&isNaN(t)&&(t=z(t,["canvas","img","video"])),"string"==typeof e&&d[e]&&(s=p(e,t,i,!0))&&(this.hook=e,l=!0,f=s.deferTexture,this.plugin=s,this.compare=s.compare,this.checkDirty=s.checkDirty,s.source&&(t=s.source)),!s&&M(t))"CANVAS"===t.tagName?(this.width=t.width,this.height=t.height,this.render=this.renderImageCanvas,l=!0,this.hook="canvas",this.compare=m):"IMG"===t.tagName&&(this.width=t.naturalWidth||1,this.height=t.naturalHeight||1,t.complete&&t.naturalWidth||(f=!0),t.addEventListener("load",function(){c.isDestroyed||((c.width!==t.naturalWidth||c.height!==t.naturalHeight)&&(c.width=t.naturalWidth,c.height=t.naturalHeight,c.resize()),c.setDirty(),c.setReady())},!0),this.render=this.renderImageCanvas,l=!0,this.hook="image",this.compare=m);else if(!s&&M(t,"WebGLTexture")){if(r&&!r.isTexture(t))throw Error("Not a valid WebGL texture.");isNaN(h)?isNaN(a)||(h=a):isNaN(a)&&(a=h),this.width=h,this.height=a,void 0===o.flip&&(u=!1),l=!0,this.texture=t,this.initialized=!0,this.hook="texture",this.compare=m,this.render=function(){}}if(!l&&!s){for(n in d)if(d.hasOwnProperty(n)&&d[n]&&(s=p(n,t,i,!1))){this.hook=n,l=!0,f=s.deferTexture,this.plugin=s,this.compare=s.compare,this.checkDirty=s.checkDirty,s.source&&(t=s.source);break}}if(!l)throw Error("Unknown source type");this.source=t,void 0===this.flip&&(this.flip=u),this.targets=[],f||c.setReady(),this.pub=new D(this),X.push(this),H[this.id]=this,J.push(this),g[this.hook].push(this),J.length&&!C&&ep()}).prototype=Object.create($.prototype),v.prototype.constructor=v,v.prototype.initialize=function(){var e;r&&!this.texture&&this.ready&&(e=r.createTexture(),r.bindTexture(r.TEXTURE_2D,e),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindTexture(r.TEXTURE_2D,null),this.texture=e,this.initialized=!0,this.allowRefresh=!0,this.setDirty())},v.prototype.initFrameBuffer=function(e){r&&(this.frameBuffer=new j(r,this.width,this.height,{texture:this.texture,useFloat:e}))},v.prototype.addTarget=function(e){var t;for(t=0;t<this.targets.length;t++)if(this.targets[t]===e)return;this.targets.push(e)},v.prototype.removeTarget=function(e){var t=this.targets&&this.targets.indexOf(e);t>=0&&this.targets.splice(t,1)},v.prototype.resize=function(){var e,t;if(this.uniforms.resolution[0]=this.width,this.uniforms.resolution[1]=this.height,this.framebuffer&&this.framebuffer.resize(this.width,this.height),this.emit("resize"),this.setDirty(),this.targets)for(e=0;e<this.targets.length;e++)(t=this.targets[e]).resize(),t.setTransformDirty&&t.setTransformDirty()},v.prototype.setReady=function(){var e;if(!this.ready&&(this.ready=!0,this.resize(),this.initialize(),this.emit("ready"),this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setReady()},v.prototype.render=function(){var e=this.source;if(r&&(e||0===e)&&this.ready)this.initialized||this.initialize(),this.allowRefresh&&this.plugin&&this.plugin.render&&(this.dirty||this.checkDirty&&this.checkDirty())&&this.plugin.render.call(this,r,e$,o,f)&&(this.dirty=!1,this.emit("render"))},v.prototype.renderImageCanvas=function(){var t=this.source;if(r&&t&&this.ready){if(this.initialized||this.initialize(),this.allowRefresh&&this.dirty){r.bindTexture(r.TEXTURE_2D,this.texture),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,this.flip),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);try{return r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t),this.dirty=!1,this.emit("render"),!0}catch(i){i.code===e.DOMException.SECURITY_ERR&&(this.allowRefresh=!1,Z.logger.error("Unable to access cross-domain image"))}return!1}}},v.prototype.destroy=function(){var e,t,i;for(this.plugin&&this.plugin.destroy&&this.plugin.destroy.call(this),r&&this.texture&&r.deleteTexture(this.texture);this.targets.length;)(i=this.targets.pop())&&i.removeSource&&i.removeSource(this);for(t in(e=J.indexOf(this))>=0&&J.splice(e,1),(e=g[this.hook].indexOf(this))>=0&&g[this.hook].splice(e,1),this)this.hasOwnProperty(t)&&"id"!==t&&delete this[t];$.prototype.destroy.call(this)},L=function(e){var t=e;Object.defineProperties(this,{source:{enumerable:!0,configurable:!0,get:function(){if(t.source)return t.source.pub},set:function(e){t.setSource(e)}},original:{enumerable:!0,configurable:!0,get:function(){return t.target}},width:{enumerable:!0,configurable:!0,get:function(){return t.width},set:function(e){!isNaN(e)&&e>0&&t.width!==e&&(t.width=e,t.resize(),t.setTransformDirty())}},height:{enumerable:!0,configurable:!0,get:function(){return t.height},set:function(e){!isNaN(e)&&e>0&&t.height!==e&&(t.height=e,t.resize(),t.setTransformDirty())}},id:{enumerable:!0,configurable:!0,get:function(){return t.id}}}),this.render=function(){t.render()},this.readPixels=function(e,i,r,n,s){return t.readPixels(e,i,r,n,s)},this.on=function(e,i){t.on(e,i)},this.off=function(e,i){t.off(e,i)},this.go=function(e){t.go(e)},this.stop=function(){t.stop()},this.getTexture=function(){return t.frameBuffer.texture},this.destroy=function(){var e,i;for(e in t.destroy(),this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((i=Object.getOwnPropertyDescriptor(this,e)).get||i.set||"function"!=typeof this[e]?delete this[e]:this[e]=E)},this.inputs=function(e){return{source:{type:"image"}}},this.isDestroyed=function(){return t.isDestroyed},this.isReady=function(){return t.ready}},(w=function(e,t,i){var s,a,c,l,d,m,y,g,v,_=this,T=!1,b=!1;function w(e,t,i,n){var s=p[e];if(s.definition){if(!(s=s.definition.call(_,t,i,n)))return null;s=I(I({},p[e]),s),_.hook=v,T=!0,_.plugin=s,_.compare=s.compare,s.target&&(t=s.target),!s.gl||_.gl||(_.gl=s.gl,r||ec(s.gl)),_.gl===r&&(_.model=o,_.shader=f)}return s}function R(e){return _.target===e}if($.call(this),(e&&"string"!=typeof e||!t&&0!==t)&&(i&&"object"==typeof i||(i=t),t=e),a=void 0===(s=i||{}).flip||s.flip,c=parseInt(s.width,10),l=parseInt(s.height,10),m=s.debugContext,"string"==typeof e&&p[e]&&w(e,t,s,!0),this.renderToTexture=s.renderToTexture,M(t,"WebGLFramebuffer")){if(y=t,M(s,"HTMLCanvasElement"))t=s;else if(M(s,"WebGLRenderingContext"))t=s.canvas;else if(M(s.canvas,"HTMLCanvasElement"))t=s.canvas;else if(M(s.context,"WebGLRenderingContext"))t=s.context.canvas;else throw Error("Must provide a canvas with WebGLFramebuffer target")}if(M(t,"HTMLCanvasElement")){if(c=t.width,l=t.height,(!r||r.canvas!==t&&s.allowSecondaryWebGL)&&(b=!0,d=V(t,{alpha:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!0,debugContext:m})),d)r&&r!==d?(this.gl=d,this.frameBuffer={frameBuffer:y||null},this.shader=new q(this.gl,u,h),this.model=ef.call(this,this.gl),this.pixels=null,this.texture=this.gl.createTexture(),this.gl.bindTexture(r.TEXTURE_2D,this.texture),this.gl.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),this.gl.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),this.gl.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),this.gl.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),this.render=this.renderSecondaryWebGL):(n||(n=this),r||ec(d),this.render=this.renderWebGL,s.renderToTexture?r&&(this.frameBuffer=new j(r,c,l,!1)):this.frameBuffer={frameBuffer:y||null});else{if(!s.allowSecondaryWebGL&&r&&r.canvas!==t)throw Error("Only one WebGL target canvas allowed. Set allowSecondaryWebGL option to create secondary context.");this.render=E,Z.logger.log("Unable to create WebGL context.")}T=!0}if(!T){for(v in p)if(p.hasOwnProperty(v)&&p[v]&&w(v,t,s,!1))break}if(!T)throw Error("Unknown target type");x&&((g=x.get(t))?Z.logger.warn("Target already in use by another instance",t,Object.keys(g).map(function(e){return g[e]})):(g={},x.set(t,g)),g[G.id]=G),this.target=t,this.transform=null,this.transformDirty=!0,this.flip=a,c&&(this.width=c),l&&(this.height=l),this.uniforms.resolution[0]=this.width,this.uniforms.resolution[1]=this.height,void 0!==s.auto?this.auto=s.auto:this.auto=eu,this.frames=0,this.pub=new L(this),X.push(this),H[this.id]=this,Q.push(this)}).prototype=Object.create($.prototype),w.prototype.constructor=w,w.prototype.setSource=function(e){var t;(t=em(e))!==this.source&&(this.source&&this.source.removeTarget(this),this.source=t,t.addTarget(this),t&&(this.resize(),t.ready?this.setReady():this.setUnready()),this.setDirty())},w.prototype.setDirty=function(){this.dirty=!0,this.auto&&!C&&(C=F(ep))},w.prototype.resize=function(){M(this.target,"HTMLCanvasElement")?(this.width!==this.target.width||this.height!==this.target.height)&&(this.target.width=this.width,this.target.height=this.height,this.uniforms.resolution[0]=this.width,this.uniforms.resolution[1]=this.height,this.emit("resize"),this.setTransformDirty()):this.plugin&&this.plugin.resize&&this.plugin.resize.call(this),this.source&&(this.source.width!==this.width||this.source.height!==this.height)&&!this.transform&&(this.transform=new Float32Array(16))},w.prototype.setTransformDirty=function(){this.transformDirty=!0,this.setDirty()},w.prototype.go=function(){this.auto=!0,this.setDirty()},w.prototype.stop=function(){this.auto=!1},w.prototype.render=function(){r&&this.plugin&&this.plugin.render&&this.plugin.render.call(this,e$,f,o)},w.prototype.renderWebGL=function(){var e,t,i;if(this.resize(),r&&this.dirty&&this.ready){if(!this.source)return;this.source.render(),this.uniforms.source=this.source.texture,this.source.width===this.width&&this.source.height===this.height?this.uniforms.transform=this.source.cumulativeMatrix||s:this.transformDirty&&(e=this.transform,B.copy(e,this.source.cumulativeMatrix||s),t=this.source.width/this.width,i=this.source.height/this.height,e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=i,e[5]*=i,e[6]*=i,e[7]*=i,this.uniforms.transform=e,this.transformDirty=!1),e$(f,o,this.uniforms,this.frameBuffer.frameBuffer,this,A),this.emit("render"),this.dirty=!1}},w.prototype.renderSecondaryWebGL=function(){var e,t,i,r,n;this.dirty&&this.ready&&this.source&&(this.emit("render"),this.source.render(!0),e=this.source.width,t=this.source.height,this.pixels&&this.pixels.length===e*t*4||(this.pixels=new Uint8Array(e*t*4)),this.source.readPixels(0,0,e,t,this.pixels),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.pixels),e===this.width&&t===this.height?this.uniforms.transform=s:this.transformDirty&&(i=this.transform,B.copy(i,s),r=this.source.width/this.width,n=this.source.height/this.height,i[0]*=r,i[1]*=r,i[2]*=r,i[3]*=r,i[4]*=n,i[5]*=n,i[6]*=n,i[7]*=n,this.uniforms.transform=i,this.transformDirty=!1),this.uniforms.source=this.texture,e$(this.shader,this.model,this.uniforms,null,this,A),this.dirty=!1)},w.prototype.removeSource=function(e){(this.source===e||this.source===e.pub)&&(this.source=null)},w.prototype.destroy=function(){var e,t;this.source&&this.source.removeTarget&&this.source.removeTarget(this),x&&(delete(t=x.get(this.target))[G.id],Object.keys(t).length||x.delete(this.target)),this.plugin&&this.plugin.destroy&&this.plugin.destroy.call(this),delete this.source,delete this.target,delete this.pub,delete this.uniforms,delete this.pixels,delete this.auto,(e=Q.indexOf(this))>=0&&Q.splice(e,1),$.prototype.destroy.call(this),this===n&&(i.removeEventListener("webglcontextrestored",el,!1),ed(),n=null)},P=function(e){var t,i=e,r=this;function n(e,t){Object.defineProperty(r,e,{configurable:!0,enumerable:!0,get:function(){return t.get.call(i)},set:function(r){var n,s,o,u,h,a;n=e,s=t,o=r,(u=i.inputElements[n],"string"==typeof o&&isNaN(o)&&("enum"===s.type?s.options.hasOwnProperty(o)||(o=z(o,["select"])):"number"===s.type||"boolean"===s.type?o=z(o,["input","select"]):"image"===s.type&&(o=z(o,["canvas","img","video"]))),M(o,"HTMLInputElement")||M(o,"HTMLSelectElement"))?(h=o.value,u&&u.element!==o&&(u.element.removeEventListener("change",u.listener,!0),u.element.removeEventListener("input",u.listener,!0),delete i.inputElements[n],u=null),!u&&(u={element:o,listener:(a=o,function(){var e,t;e="checkbox"===o.type?o.checked:a.value,t=i.setInput(n,e),"color"===o.type&&(t=k(t)),t!==e&&(a.value=t)})},i.inputElements[n]=u,"range"===o.type&&o.addEventListener("input",u.listener,!0),o.addEventListener("change",u.listener,!0)),u&&"checkbox"===o.type&&(h=o.checked)):(u&&(u.element.removeEventListener("change",u.listener,!0),u.element.removeEventListener("input",u.listener,!0),delete i.inputElements[n]),h=o),i.setInput(n,h)}})}function s(e){return function(){e.apply(i,arguments)&&i.setTransformDirty()}}for(t in Object.defineProperties(this,{transform:{enumerable:!0,configurable:!0,get:function(){return i.hook}},title:{enumerable:!0,configurable:!0,get:function(){return i.plugin.title||i.hook}},width:{enumerable:!0,configurable:!0,get:function(){return i.width}},height:{enumerable:!0,configurable:!0,get:function(){return i.height}},id:{enumerable:!0,configurable:!0,get:function(){return i.id}},source:{enumerable:!0,configurable:!0,get:function(){return i.source&&i.source.pub},set:function(e){i.setSource(e)}}}),i.methods)i.methods.hasOwnProperty(t)&&(this[t]=s(i.methods[t]));for(t in i.inputs)i.inputs.hasOwnProperty(t)&&n(t,i.inputs[t]);this.update=function(){i.setDirty()},this.inputs=function(e){var t,r,n,s;if(n=i.plugin.inputs,e)return(r=n[e])&&!r.method?(t={type:r.type,defaultValue:r.defaultValue,title:r.title||e},"number"===r.type?(t.min=r.min,t.max=r.max,t.step=r.step,t.mod=r.mod):"enum"===r.type?t.options=I({},r.options):"vector"===r.type&&(t.dimensions=r.dimensions),r.description&&(t.description=r.description),t):null;for(s in t={},n)n.hasOwnProperty(s)&&!n[s].method&&(t[s]=this.inputs(s));return t},this.alias=function(e,t){return i.alias(e,t),this},this.on=function(e,t){i.on(e,t)},this.off=function(e,t){i.off(e,t)},this.destroy=function(){var e,t;for(e in i.destroy(),this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((t=Object.getOwnPropertyDescriptor(this,e)).get||t.set||"function"!=typeof this[e]?delete this[e]:this[e]=E)},this.isDestroyed=function(){return i.isDestroyed},this.isReady=function(){return i.ready}},(b=function(e,t){var i,r,n,s,o;for(i in this.matrix=new Float32Array(16),this.cumulativeMatrix=new Float32Array(16),this.ready=!1,this.width=1,this.height=1,this.seriously=G,this.transformRef=l[e],this.hook=e,this.id=K,K++,this.options=t,this.sources=null,this.targets=[],this.inputElements={},this.inputs={},this.methods={},this.listeners={},this.texture=null,this.frameBuffer=null,this.uniforms=null,this.dirty=!0,this.transformDirty=!0,this.renderDirty=!1,this.isDestroyed=!1,this.transformed=!1,this.plugin=I({},this.transformRef),this.transformRef.definition&&I(this.plugin,this.transformRef.definition.call(this,t)),this.plugin.inputs)this.plugin.inputs.hasOwnProperty(i)&&((r=this.plugin.inputs[i]).method&&"function"==typeof r.method?this.methods[i]=r.method:"function"==typeof r.set&&"function"==typeof r.get&&(this.inputs[i]=r));for(i in Y(this.plugin),o=es[e],this.plugin.inputs)this.plugin.inputs.hasOwnProperty(i)&&"function"==typeof(r=this.plugin.inputs[i]).set&&"function"==typeof r.get&&"function"!=typeof r.method&&(n=r.get.call(this),s=void 0===r.defaultValue?n:r.defaultValue,s=r.validate.call(this,s,r,n),o&&void 0!==o[i]&&(s=r.validate.call(this,o[i],r,r.defaultValue,s),o[i]=s),s!==n&&r.set.call(this,s));X.push(this),H[this.id]=this,this.pub=new P(this),ee.push(this),y[e].push(this)}).prototype=Object.create($.prototype),b.prototype.constructor=b,b.prototype.setDirty=function(){this.renderDirty=!0,$.prototype.setDirty.call(this)},b.prototype.setTransformDirty=function(){var e,t;for(e=0,this.transformDirty=!0,this.dirty=!0,this.renderDirty=!0;e<this.targets.length;e++)(t=this.targets[e]).setTransformDirty?t.setTransformDirty():t.setDirty()},b.prototype.resize=function(){var e;for($.prototype.resize.call(this),this.plugin.resize&&this.plugin.resize.call(this),e=0;e<this.targets.length;e++)this.targets[e].resize();this.setTransformDirty()},b.prototype.setSource=function(e){var t;if((t=em(e))!==this.source){if(ey(t,this))throw Error("Attempt to make cyclical connection.");this.source&&this.source.removeTarget(this),this.source=t,t.addTarget(this),t&&t.ready?this.setReady():this.setUnready(),this.resize()}},b.prototype.addTarget=function(e){var t;for(t=0;t<this.targets.length;t++)if(this.targets[t]===e)return;this.targets.push(e)},b.prototype.removeTarget=function(e){var t=this.targets&&this.targets.indexOf(e);t>=0&&this.targets.splice(t,1),this.targets&&this.targets.length&&this.resize()},b.prototype.setInput=function(e,t){var i,r,n;if(this.plugin.inputs.hasOwnProperty(e))return i=this.plugin.inputs[e],r=es[this.hook]&&void 0!==es[this.hook][e]?es[this.hook][e]:i.defaultValue,n=i.get.call(this),void 0===r&&(r=n),t=i.validate.call(this,t,i,r,n),i.set.call(this,t)&&this.setTransformDirty(),i.get.call(this)},b.prototype.alias=function(e,t){var i,r,n=this;if(O.indexOf(t)>=0)throw Error("'"+t+"' is a reserved name and cannot be used as an alias.");return this.plugin.inputs.hasOwnProperty(e)&&(t||(t=e),G.removeAlias(t),(i=this.inputs[e])?(r=n.inputs[e],Object.defineProperty(G,t,{configurable:!0,enumerable:!0,get:function(){return r.get.call(n)},set:function(e){r.set.call(n,e)&&n.setTransformDirty()}})):(i=this.methods[e])&&(r=i,G[t]=function(){r.apply(n,arguments)&&n.setTransformDirty()}),i&&(ei[t]={node:this,input:e})),this},b.prototype.render=function(e){if(!this.source){this.transformDirty&&(B.copy(this.cumulativeMatrix,this.matrix),this.transformDirty=!1),this.texture=null,this.dirty=!1;return}return this.source.render(),this.transformDirty&&(this.transformed?this.source.cumulativeMatrix?B.multiply(this.cumulativeMatrix,this.matrix,this.source.cumulativeMatrix):B.copy(this.cumulativeMatrix,this.matrix):B.copy(this.cumulativeMatrix,this.source.cumulativeMatrix||s),this.transformDirty=!1),e&&r?(this.renderDirty&&(this.frameBuffer||(this.uniforms={resolution:[this.width,this.height]},this.frameBuffer=new j(r,this.width,this.height)),this.uniforms.source=this.source.texture,this.uniforms.transform=this.cumulativeMatrix||s,e$(f,o,this.uniforms,this.frameBuffer.frameBuffer,this),this.renderDirty=!1),this.texture=this.frameBuffer.texture):this.source?this.texture=this.source.texture:this.texture=null,this.dirty=!1,this.texture},b.prototype.readPixels=function(e,t,i,n,s){var o=this.gl||r;if(!r)throw Error("Cannot read pixels until a canvas is connected");if(this.render(!0),void 0===s)s=new Uint8Array(i*n*4);else if(!M(s,"Uint8Array"))throw Error("Incompatible array type");return o.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer.frameBuffer),o.readPixels(e,t,i,n,r.RGBA,r.UNSIGNED_BYTE,s),s},b.prototype.destroy=function(){var e,t,i,r=this.hook;for(e in this.plugin.destroy&&"function"==typeof this.plugin.destroy&&this.plugin.destroy.call(this),delete this.effect,this.frameBuffer&&(this.frameBuffer.destroy(),delete this.frameBuffer,delete this.texture),this.inputElements)this.inputElements.hasOwnProperty(e)&&((i=this.inputElements[e]).element.removeEventListener("change",i.listener,!0),i.element.removeEventListener("input",i.listener,!0));for(this.source&&this.source.removeTarget(this);this.targets.length;)(i=this.targets.pop())&&i.removeSource&&i.removeSource(this);for(t in this)this.hasOwnProperty(t)&&"id"!==t&&delete this[t];for(t in ei)ei.hasOwnProperty(t)&&(i=ei[t]).node===this&&G.removeAlias(t);(e=ee.indexOf(this))>=0&&ee.splice(e,1),(e=y[r].indexOf(this))>=0&&y[r].splice(e,1),$.prototype.destroy.call(this)},b.prototype.setReady=$.prototype.setReady,b.prototype.setUnready=$.prototype.setUnready,b.prototype.on=$.prototype.on,b.prototype.off=$.prototype.off,b.prototype.emit=$.prototype.emit,(t=M(t,"HTMLCanvasElement")?{canvas:t}:t||{}).canvas,this.effect=function(e,t){if(!c[e])throw Error("Unknown effect: "+e);return new T(e,t).pub},this.source=function(e,t,i){return em(e,t,i).pub},this.transform=function(e,i){var r;if("string"!=typeof e&&(i=e,e=!1),e){if(!l[e])throw Error("Unknown transform: "+e)}else if(!l[e=t&&t.defaultTransform||"2d"])throw Error("No transform specified");return(r=new b(e,i)).pub},this.target=function(e,t,i){var r,n,s;for(e&&"string"==typeof e&&!p[e]&&(n=a.querySelector(e)),("string"!=typeof e||!t&&0!==t||n)&&(i&&"object"==typeof i||(i=t),t=n||e,e=null),"string"==typeof t&&isNaN(t)&&(t=a.querySelector(t)),s=0;s<Q.length;s++)if(r=Q[s],(!e||e===r.hook)&&(r.target===t||r.compare&&r.compare(t,i)))return r.pub;return(r=new w(e,t,i)).pub},this.aliases=function(){return Object.keys(ei)},this.removeAlias=function(e){ei[e]&&(delete this[e],delete ei[e])},this.defaults=function(e,t){var i;if(!e){if(null===e)for(i in es)es.hasOwnProperty(i)&&delete es[i];return}if("object"==typeof e){for(i in e)e.hasOwnProperty(i)&&this.defaults(i,e[i]);return}null===t?delete es[e]:"object"==typeof t&&(es[e]=I({},t))},this.go=function(e,t){var i;for("function"==typeof e&&0>er.indexOf(e)&&er.push(e),"function"==typeof t&&0>en.indexOf(t)&&en.push(t),eu=!0,i=0;i<Q.length;i++)Q[i].go();!C&&(er.length||en.length)&&ep()},this.stop=function(){er.length=0,en.length=0,U(C),C=0},this.render=function(){var e;for(e=0;e<Q.length;e++)Q[e].render(t)},this.destroy=function(){for(var e,t,i;X.length;)(t=X[0]).pub.destroy();for(e in this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((i=Object.getOwnPropertyDescriptor(this,e)).get||i.set||"function"!=typeof this[e]?delete this[e]:this[e]=E);G=null,J=[],Q=[],et=[],X=[],er.length=0,en.length=0,U(C),C=0,eh=!0},this.isDestroyed=function(){return eh},this.incompatible=function(e){var t,i,r=!1;if(r=Z.incompatible(e))return r;if(!e){for(t in m)if(m.hasOwnProperty(t)&&m[t].length&&(i=c[t])&&"function"==typeof i.compatible&&!i.compatible.call(this))return"plugin-"+t;for(t in g)if(g.hasOwnProperty(t)&&g[t].length&&(i=d[t])&&"function"==typeof i.compatible&&!i.compatible.call(this))return"source-"+t}return!1},this.isNode=function(e){var t;return!!e&&!!(t=H[e.id])&&!t.isDestroyed},this.isSource=function(e){return this.isNode(e)&&e instanceof D},this.isEffect=function(e){return this.isNode(e)&&e instanceof R},this.isTransform=function(e){return this.isNode(e)&&e instanceof P},this.isTarget=function(e){return this.isNode(e)&&e instanceof L},Object.defineProperties(this,{id:{enumerable:!0,configurable:!0,get:function(){return N}}}),this.defaults(t.defaults)}return e.addEventListener("message",function(t){t.source===e&&"seriously-timeout-message"===t.data&&(t.stopPropagation(),$.length>0)&&$.shift()()},!0),j.prototype.resize=function(e,t){var i=this.gl;if(this.width!==e||this.height!==t)this.width=e,this.height=t,i&&(i.bindTexture(i.TEXTURE_2D,this.texture),i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.bindRenderbuffer(i.RENDERBUFFER,this.renderBuffer),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,null),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.texture,0),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null))},j.prototype.destroy=function(){var e=this.gl;e&&(e.deleteFramebuffer(this.frameBuffer),e.deleteRenderbuffer(this.renderBuffer),this.ownTexture&&e.deleteTexture(this.texture)),delete this.frameBuffer,delete this.renderBuffer,delete this.texture,delete this.gl},q.prototype.use=function(){this.gl.useProgram(this.program)},Z.incompatible=function(t){var i,r,s;if(void 0!==n||((i=a.createElement("canvas"))&&i.getContext?e.WebGLRenderingContext?(r=H())||(n="context"):n="webgl":n="canvas"),n)return n;if(t){if((s=c[t])&&"function"==typeof s.compatible&&!s.compatible(r))return"plugin-"+t;if((s=d[t])&&"function"==typeof s.compatible&&!s.compatible(r))return"source-"+t}return!1},Z.plugin=function(e,t,i){var r;if(c[e]){Z.logger.warn("Effect ["+e+"] already loaded");return}if(void 0===i&&"object"==typeof t&&(i=t),i)return r=I({},i),"function"==typeof t&&(r.definition=t),r.reserved=L,r.inputs&&Y(r),r.title||(r.title=e),c[e]=r,m[e]=[],r},Z.removePlugin=function(e){var t,i,r;if(!e||!(r=c[e]))return this;if(t=m[e]){for(;t.length;)(i=t.shift()).destroy();delete m[e]}return delete c[e],this},Z.source=function(e,t,i){var r;if(d[e]){Z.logger.warn("Source ["+e+"] already loaded");return}if(void 0===i&&"object"==typeof t&&(i=t),i||t)return r=I({},i),"function"==typeof t&&(r.definition=t),r.title||(r.title=e),d[e]=r,g[e]=[],r},Z.removeSource=function(e){var t,i,r;if(!e||!(r=d[e]))return this;if(t=g[e]){for(;t.length;)(i=t.shift()).destroy();delete g[e]}return delete d[e],this},Z.transform=function(e,t,i){var r;if(l[e]){Z.logger.warn("Transform ["+e+"] already loaded");return}if(void 0===i&&"object"==typeof t&&(i=t),i||t)return r=I({},i),"function"==typeof t&&(r.definition=t),r.reserved=C,r.inputs&&Y(r),r.title||(r.title=e),l[e]=r,y[e]=[],r},Z.removeTransform=function(e){var t,i,r;if(!e||!(r=l[e]))return this;if(t=y[e]){for(;t.length;)(i=t.shift()).destroy();delete y[e]}return delete l[e],this},Z.target=function(e,t,i){var r;if(p[e]){Z.logger.warn("Target ["+e+"] already loaded");return}if(void 0===i&&"object"==typeof t&&(i=t),i||t)return r=I({},i),"function"==typeof t&&(r.definition=t),r.title||(r.title=e),p[e]=r,v[e]=[],r},Z.removeTarget=function(e){var t,i,r;if(!e||!(r=p[e]))return this;if(t=v[e]){for(;t.length;)(i=t.shift()).destroy();delete v[e]}return delete p[e],this},Z.inputValidators={color:function(e,t,i,n){var s,o,u,h;if(o=n||[],"string"==typeof e){if((u=b.exec(e))&&u.length){if(u.length<3)return o[0]=o[1]=o[2]=o[3]=0,o;for(h=0,o[3]=1;h<3;h++)o[h]=parseFloat(u[h+2])/255;return(isNaN(u[6])||(o[3]=parseFloat(u[6])),"hsl"===u[1].toLowerCase())?G(o[0],o[1],o[2],o[3],o):o}if((u=w.exec(e))&&u.length)return 3===(s=u[1]).length?(o[0]=parseInt(s[0],16)/15,o[1]=parseInt(s[1],16)/15,o[2]=parseInt(s[2],16)/15,o[3]=1):4===s.length?(o[0]=parseInt(s[0],16)/15,o[1]=parseInt(s[1],16)/15,o[2]=parseInt(s[2],16)/15,o[3]=parseInt(s[3],16)/15):6===s.length?(o[0]=parseInt(s.substr(0,2),16)/255,o[1]=parseInt(s.substr(2,2),16)/255,o[2]=parseInt(s.substr(4,2),16)/255,o[3]=1):8===s.length?(o[0]=parseInt(s.substr(0,2),16)/255,o[1]=parseInt(s.substr(2,2),16)/255,o[2]=parseInt(s.substr(4,2),16)/255,o[3]=parseInt(s.substr(6,2),16)/255):o[0]=o[1]=o[2]=o[3]=0,o;if(u=T[e.toLowerCase()]){for(h=0;h<4;h++)o[h]=u[h];return o}return(r||(r=a.createElement("canvas").getContext("2d")),r.fillStyle=e,(s=r.fillStyle)&&"#000000"!==s)?Z.inputValidators.color(s,t,i,n):(o[0]=o[1]=o[2]=o[3]=0,o)}if(X(e)){if((o=e).length<3)return o[0]=o[1]=o[2]=o[3]=0,o;for(h=0;h<3;h++)if(isNaN(o[h]))return o[0]=o[1]=o[2]=o[3]=0,o;return o.length<4&&o.push(1),o}if("number"==typeof e)return o[0]=o[1]=o[2]=e,o[3]=1,o;if("object"==typeof e){for(h=0;h<4;h++)null===e[s=D[h]]||isNaN(e[s])?o[h]=3===h?1:0:o[h]=e[s];return o}return o[0]=o[1]=o[2]=o[3]=0,o},number:function(e,t,i){return isNaN(e=parseFloat(e))?i||0:(t.mod&&(e-=t.mod*Math.floor(e/t.mod)),e<t.min)?t.min:e>t.max?t.max:t.step?Math.round(e/t.step)*t.step:e},enum:function(e,t,i){var r=t.options||[];return("string"==typeof e?e=e.toLowerCase():"number"==typeof e?e=e.toString():e||(e=""),r.hasOwnProperty(e))?e:i||""},vector:function(e,t,i,r){var n,s,o,u=t.dimensions||4;if(n=r||[],X(e)){for(s=0;s<u;s++)n[s]=e[s]||0;return n}if("object"==typeof e){for(s=0;s<u;s++)void 0===e[o=R[s]]&&(o=D[s]),n[s]=e[o]||0;return n}for(s=0,e=parseFloat(e)||0;s<u;s++)n[s]=e;return n},boolean:function(e){return!!e&&(!e||!e.toLowerCase||"false"!==e.toLowerCase())},string:function(e){return"string"==typeof e?e:0===e||e?e.toString?e.toString():String(e):""}},Z.prototype.effects=Z.effects=function(){var e,t,i,r,n,s={};for(e in c)if(c.hasOwnProperty(e)){for(n in i={title:(t=c[e]).title||e,description:t.description||"",inputs:{}},t.inputs)t.inputs.hasOwnProperty(n)&&(r=t.inputs[n],i.inputs[n]={type:r.type,defaultValue:r.defaultValue,step:r.step,min:r.min,max:r.max,mod:r.mod,minCount:r.minCount,maxCount:r.maxCount,dimensions:r.dimensions,title:r.title||n,description:r.description||"",options:r.options||[]});s[e]=i}return s},e.Float32Array&&(s=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])),e.Seriously&&"object"==typeof e.Seriously&&function(){var t;for(t in e.Seriously)e.Seriously.hasOwnProperty(t)&&"plugin"!==t&&"object"==typeof e.Seriously[t]&&Z.plugin(t,e.Seriously[t])}(),Z.logger={log:N("log"),info:N("info"),warn:N("warn"),error:N("error")},Z.util={mat4:B,checkSource:function t(i){var r,n,s,o;if(!(r=z(i,["img","canvas","video"])))return!1;if(!(n=a.createElement("canvas")))return Z.logger.warn("Browser does not support canvas or Seriously.js"),!1;if(0===r.naturalWidth&&"IMG"===r.tagName)return Z.logger.warn("Image not loaded"),!1;if(0===r.readyState&&0===r.videoWidth&&"VIDEO"===r.tagName)return Z.logger.warn("Video not loaded"),!1;if(s=H()){(o=s.createTexture())||Z.logger.error("Test WebGL context has been lost"),s.bindTexture(s.TEXTURE_2D,o);try{s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,r)}catch(u){return u.code===e.DOMException.SECURITY_ERR?Z.logger.log("Unable to access cross-domain image"):Z.logger.error("Error storing image to texture: "+u.message),s.deleteTexture(o),!1}s.deleteTexture(o)}else{s=n.getContext("2d");try{s.drawImage(r,0,0),s.getImageData(0,0,1,1)}catch(h){return h.code===e.DOMException.SECURITY_ERR?Z.logger.log("Unable to access cross-domain image"):Z.logger.error("Error drawing image to canvas: "+h.message),!1}}return!0},hslToRgb:G,colors:T,setTimeoutZero:W,ShaderProgram:q,FrameBuffer:j,requestAnimationFrame:F,shader:{makeNoise:"float makeNoise(float u, float v, float timer) {\n	float x = u * v * mod(timer * 1000.0, 100.0);\n	x = mod(x, 13.0) * mod(x, 127.0);\n	float dx = mod(x, 0.01);\n	return clamp(0.1 + dx * 100.0, 0.0, 1.0);\n}\n",random:"#ifndef RANDOM\n#define RANDOM\nfloat random(vec2 n) {\n	return 0.5 + 0.5 * fract(sin(dot(n.xy, vec2(12.9898, 78.233)))* 43758.5453);\n}\n#endif\n"}},Z.source("video",function(t,i,r){var n,s,u=this,h=!1,f=!1,c=!1,l=0;function d(){t.removeEventListener("loadedmetadata",d,!0),!h&&(t.videoWidth?((u.width!==t.videoWidth||u.height!==t.videoHeight)&&(u.width=t.videoWidth,u.height=t.videoHeight,u.resize()),f&&u.setReady()):(f=!0,setTimeout(d,50)))}function p(){c=!0}function $(){c=!1,u.setDirty()}if(M(t,"HTMLVideoElement"))return t.readyState?d():(f=!0,t.addEventListener("loadedmetadata",d,!0)),t.addEventListener("seeking",p,!1),t.addEventListener("seeked",$,!1),{deferTexture:f,source:t,render:function i(r){var h,f;if(l=t.currentTime,!t.videoHeight||!t.videoWidth)return!1;o?(s||((n=(s=a.createElement("canvas").getContext("2d")).canvas).width=u.width,n.height=u.height),h=n,s.drawImage(t,0,0,u.width,u.height)):h=t,r.bindTexture(r.TEXTURE_2D,u.texture),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,u.flip),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,h),void 0===o){if((f=r.getError())===r.INVALID_VALUE)return o=!0,i(r);o=!1}return!0}catch(c){c.code===e.DOMException.SECURITY_ERR?(u.allowRefresh=!1,Z.logger.error("Unable to access cross-domain image")):Z.logger.error("Error rendering video source",c)}return!1},checkDirty:function(){return!c&&t.currentTime!==l},compare:function(e){return u.source===e},destroy:function(){h=!0,t.removeEventListener("seeking",p,!1),t.removeEventListener("seeked",$,!1),t.removeEventListener("loadedmetadata",d,!0)}}},{title:"Video"}),Z.transform("2d",function(e){var t=this,i=!(e&&e.radians),r=0,n=0,s=1,o=1,u=0,h=0,a=0,f=0,c=0;function l(){var e,l,d,p,$,m,y,g,v,x,_,E=t.matrix;function T(e,t){E[12]=E[0]*e+E[4]*t+E[12],E[13]=E[1]*e+E[5]*t+E[13],E[14]=E[2]*e+E[6]*t+E[14],E[15]=E[3]*e+E[7]*t+E[15]}if(!u&&!h&&!a&&!f&&!c&&1===s&&1===o){t.transformed=!1;return}B.identity(E),T(u+r,h+n),f&&(E[4]=f/t.width),c&&(E[1]=c/t.height),a&&(p=E[0],$=E[1],m=E[2],y=E[3],g=E[4],v=E[5],x=E[6],_=E[7],l=Math.sin(e=-(i?a*Math.PI/180:a)),d=Math.cos(e),E[0]=p*d+g*l,E[1]=$*d+v*l,E[2]=m*d+x*l,E[3]=y*d+_*l,E[4]=g*d-p*l,E[5]=v*d-$*l,E[6]=x*d-m*l,E[7]=_*d-y*l),1!==s&&(E[0]*=s,E[1]*=s,E[2]*=s,E[3]*=s),1!==o&&(E[4]*=o,E[5]*=o,E[6]*=o,E[7]*=o),T(-r,-n),t.transformed=!0}return{inputs:{reset:{method:function(){return r=0,n=0,s=1,o=1,u=0,h=0,a=0,f=0,c=0,!!t.transformed&&(t.transformed=!1,!0)}},translate:{method:function(e,t){return isNaN(e)&&(e=u),isNaN(t)&&(t=h),(e!==u||t!==h)&&(u=e,h=t,l(),!0)},type:["number","number"]},translateX:{get:function(){return u},set:function(e){return e!==u&&(u=e,l(),!0)},type:"number"},translateY:{get:function(){return h},set:function(e){return e!==h&&(h=e,l(),!0)},type:"number"},rotation:{get:function(){return a},set:function(e){return e!==a&&(a=parseFloat(e),l(),!0)},type:"number"},center:{method:function(e,t){return isNaN(e)&&(e=r),isNaN(t)&&(t=n),(e!==r||t!==n)&&(r=e,n=t,l(),!0)},type:["number","number"]},centerX:{get:function(){return r},set:function(e){return e!==r&&(r=e,l(),!0)},type:"number"},centerY:{get:function(){return n},set:function(e){return e!==n&&(n=e,l(),!0)},type:"number"},skew:{method:function(e,t){return isNaN(e)&&(e=f),isNaN(t)&&(t=c),(e!==f||t!==c)&&(f=e,c=t,l(),!0)},type:["number","number"]},skewX:{get:function(){return f},set:function(e){return e!==f&&(f=e,l(),!0)},type:"number"},skewY:{get:function(){return c},set:function(e){return e!==c&&(c=e,l(),!0)},type:"number"},scale:{method:function(e,t){var i,r;if(i=isNaN(e)?s:e,isNaN(t)){if(isNaN(e))return!1;r=i}else r=t;return(i!==s||r!==o)&&(s=i,o=r,l(),!0)},type:["number","number"]},scaleX:{get:function(){return s},set:function(e){return e!==s&&(s=e,l(),!0)},type:"number"},scaleY:{get:function(){return o},set:function(e){return e!==o&&(o=e,l(),!0)},type:"number"}}}},{title:"2D Transform",description:"Translate, Rotate, Scale, Skew"}),Z.transform("flip",function(){var e=this,t=!0;function i(){var i=e.matrix;t?(i[0]=-1,i[5]=1):(i[0]=1,i[5]=-1)}return B.identity(e.matrix),i(),e.transformDirty=!0,e.transformed=!0,{inputs:{direction:{get:function(){return t?"horizontal":"vertical"},set:function(e){var r;return(r="vertical"!==e)!==t&&(t=r,i(),!0)},type:"string"}}}},{title:"Flip",description:"Flip Horizontal/Vertical"}),Z.transform("reformat",function(){var e,t,i=this,r="contain";function n(){var n,s,o,u,h=i.matrix,a=e||i.width,f=t||i.height,c=i.source,l=c&&c.width||1,d=c&&c.height||1;if("distort"===r||a===l&&f===d||(o=l/d,u=a/f,"none"===r?(n=l/a,s=d/f):"width"===r||"contain"===r&&u<=o?(n=1,s=u/o):"height"===r||"contain"===r&&u>o?(n=o/u,s=1):u>o?(n=1,s=u/o):(n=o/u,s=1),1===n&&1===s)){i.transformed=!1;return}B.identity(h),1!==n&&(h[0]*=n,h[1]*=n,h[2]*=n,h[3]*=n),1!==s&&(h[4]*=s,h[5]*=s,h[6]*=s,h[7]*=s),i.transformed=!0}function s(){return e||i.source&&i.source.width||1}function o(){return t||i.source&&i.source.height||1}return this.resize=function(){var e,t=s(),i=o();if(this.width!==t||this.height!==i)for(this.width=t,this.height=i,this.uniforms&&this.uniforms.resolution&&(this.uniforms.resolution[0]=t,this.uniforms.resolution[1]=i),this.frameBuffer&&this.frameBuffer.resize&&this.frameBuffer.resize(t,i),e=0;e<this.targets.length;e++)this.targets[e].resize();this.setTransformDirty(),n()},{inputs:{width:{get:s,set:function(t){return(t=Math.floor(t))!==e&&(e=t,this.resize(),!1)},type:"number"},height:{get:o,set:function(e){return(e=Math.floor(e))!==t&&(t=e,this.resize(),!1)},type:"number"},mode:{get:function(){return r},set:function(e){return e!==r&&(r=e,n(),!0)},type:"enum",options:["cover","contain","distort","width","height","none"]}}}},{title:"Reformat",description:"Change output dimensions"}),u="precision mediump float;\nattribute vec4 position;\nattribute vec2 texCoord;\nuniform vec2 resolution;\nuniform mat4 transform;\nvarying vec2 vTexCoord;\nvoid main(void) {\n	vec4 screenPosition = vec4(position.xy * resolution / 2.0, position.z, position.w);\n	screenPosition = transform * screenPosition;\n	gl_Position.xy = screenPosition.xy * 2.0 / resolution;\n	gl_Position.z = screenPosition.z * 2.0 / (resolution.x / resolution.y);\n	gl_Position.w = screenPosition.w;\n	vTexCoord = texCoord;\n}\n",h="precision mediump float;\nvarying vec2 vTexCoord;\nuniform sampler2D source;\nvoid main(void) {\n		gl_FragColor = texture2D(source, vTexCoord);\n}",Z.util.shader.noiseHelpers="#ifndef NOISE_HELPERS\n#define NOISE_HELPERS\nvec2 mod289(vec2 x) {\n	return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\nvec3 mod289(vec3 x) {\n	return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\nvec4 mod289(vec4 x) {\n	return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\nvec3 permute(vec3 x) {\n	return mod289(((x*34.0)+1.0)*x);\n}\nvec4 permute(vec4 x) {\n	return mod289(((x*34.0)+1.0)*x);\n}\nvec4 taylorInvSqrt(vec4 r) {\n	return 1.79284291400159 - 0.85373472095314 * r;\n}\nfloat taylorInvSqrt(float r) {\n	return 1.79284291400159 - 0.85373472095314 * r;\n}\n#endif\n",Z.util.shader.snoise2d="#ifndef NOISE2D\n#define NOISE2D\nfloat snoise(vec2 v) {\n	const vec4 C = vec4(0.211324865405187, // (3.0-sqrt(3.0))/6.0\n		0.366025403784439, // 0.5*(sqrt(3.0)-1.0)\n		-0.577350269189626, // -1.0 + 2.0 * C.x\n		0.024390243902439); // 1.0 / 41.0\n	vec2 i = floor(v + dot(v, C.yy));\n	vec2 x0 = v - i + dot(i, C.xx);\n	vec2 i1;\n	//i1.x = step(x0.y, x0.x); // x0.x > x0.y ? 1.0 : 0.0\n	//i1.y = 1.0 - i1.x;\n	i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n	// x0 = x0 - 0.0 + 0.0 * C.xx ;\n	// x1 = x0 - i1 + 1.0 * C.xx ;\n	// x2 = x0 - 1.0 + 2.0 * C.xx ;\n	vec4 x12 = x0.xyxy + C.xxzz;\n	x12.xy -= i1;\n	i = mod289(i); // Avoid truncation effects in permutation\n	vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));\n	vec3 m = max(0.5 - vec3(dot(x0, x0), dot(x12.xy, x12.xy), dot(x12.zw, x12.zw)), 0.0);\n	m = m*m ;\n	m = m*m ;\n	vec3 x = 2.0 * fract(p * C.www) - 1.0;\n	vec3 h = abs(x) - 0.5;\n	vec3 ox = floor(x + 0.5);\n	vec3 a0 = x - ox;\n	m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);\n	vec3 g;\n	g.x = a0.x * x0.x + h.x * x0.y;\n	g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n	return 130.0 * dot(m, g);\n}\n#endif\n",Z.util.shader.snoise3d="#ifndef NOISE3D\n#define NOISE3D\nfloat snoise(vec3 v) {\n	const vec2 C = vec2(1.0/6.0, 1.0/3.0) ;\n	const vec4 D = vec4(0.0, 0.5, 1.0, 2.0);\n	vec3 i = floor(v + dot(v, C.yyy));\n	vec3 x0 = v - i + dot(i, C.xxx) ;\n	vec3 g = step(x0.yzx, x0.xyz);\n	vec3 l = 1.0 - g;\n	vec3 i1 = min(g.xyz, l.zxy);\n	vec3 i2 = max(g.xyz, l.zxy);\n	// x0 = x0 - 0.0 + 0.0 * C.xxx;\n	// x1 = x0 - i1 + 1.0 * C.xxx;\n	// x2 = x0 - i2 + 2.0 * C.xxx;\n	// x3 = x0 - 1.0 + 3.0 * C.xxx;\n	vec3 x1 = x0 - i1 + C.xxx;\n	vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y\n	vec3 x3 = x0 - D.yyy; // -1.0+3.0*C.x = -0.5 = -D.y\n	i = mod289(i);\n	vec4 p = permute(permute(permute(\n						i.z + vec4(0.0, i1.z, i2.z, 1.0))\n						+ i.y + vec4(0.0, i1.y, i2.y, 1.0))\n						+ i.x + vec4(0.0, i1.x, i2.x, 1.0));\n	float n_ = 0.142857142857; // 1.0/7.0\n	vec3 ns = n_ * D.wyz - D.xzx;\n	vec4 j = p - 49.0 * floor(p * ns.z * ns.z); // mod(p, 7 * 7)\n	vec4 x_ = floor(j * ns.z);\n	vec4 y_ = floor(j - 7.0 * x_); // mod(j, N)\n	vec4 x = x_ * ns.x + ns.yyyy;\n	vec4 y = y_ * ns.x + ns.yyyy;\n	vec4 h = 1.0 - abs(x) - abs(y);\n	vec4 b0 = vec4(x.xy, y.xy);\n	vec4 b1 = vec4(x.zw, y.zw);\n	//vec4 s0 = vec4(lessThan(b0, 0.0)) * 2.0 - 1.0;\n	//vec4 s1 = vec4(lessThan(b1, 0.0)) * 2.0 - 1.0;\n	vec4 s0 = floor(b0) * 2.0 + 1.0;\n	vec4 s1 = floor(b1) * 2.0 + 1.0;\n	vec4 sh = -step(h, vec4(0.0));\n	vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy ;\n	vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww ;\n	vec3 p0 = vec3(a0.xy, h.x);\n	vec3 p1 = vec3(a0.zw, h.y);\n	vec3 p2 = vec3(a1.xy, h.z);\n	vec3 p3 = vec3(a1.zw, h.w);\n	vec4 norm = taylorInvSqrt(vec4(dot(p0, p0), dot(p1, p1), dot(p2, p2), dot(p3, p3)));\n	p0 *= norm.x;\n	p1 *= norm.y;\n	p2 *= norm.z;\n	p3 *= norm.w;\n	vec4 m = max(0.6 - vec4(dot(x0, x0), dot(x1, x1), dot(x2, x2), dot(x3, x3)), 0.0);\n	m = m * m;\n	return 42.0 * dot(m*m, vec4(dot(p0, x0), dot(p1, x1), dot(p2, x2), dot(p3, x3)));\n}\n#endif\n",Z.util.shader.snoise4d="#ifndef NOISE4D\n#define NOISE4D\nvec4 grad4(float j, vec4 ip)\n	{\n	const vec4 ones = vec4(1.0, 1.0, 1.0, -1.0);\n	vec4 p, s;\n\n	p.xyz = floor(fract (vec3(j) * ip.xyz) * 7.0) * ip.z - 1.0;\n	p.w = 1.5 - dot(abs(p.xyz), ones.xyz);\n	s = vec4(lessThan(p, vec4(0.0)));\n	p.xyz = p.xyz + (s.xyz*2.0 - 1.0) * s.www;\n\n	return p;\n	}\n\n#define F4 0.309016994374947451\n\nfloat snoise(vec4 v)\n	{\n	const vec4 C = vec4(0.138196601125011, // (5 - sqrt(5))/20 G4\n						0.276393202250021, // 2 * G4\n						0.414589803375032, // 3 * G4\n						-0.447213595499958); // -1 + 4 * G4\n\n	vec4 i = floor(v + dot(v, vec4(F4)));\n	vec4 x0 = v - i + dot(i, C.xxxx);\n\n\n	vec4 i0;\n	vec3 isX = step(x0.yzw, x0.xxx);\n	vec3 isYZ = step(x0.zww, x0.yyz);\n	i0.x = isX.x + isX.y + isX.z;\n	i0.yzw = 1.0 - isX;\n	i0.y += isYZ.x + isYZ.y;\n	i0.zw += 1.0 - isYZ.xy;\n	i0.z += isYZ.z;\n	i0.w += 1.0 - isYZ.z;\n\n	vec4 i3 = clamp(i0, 0.0, 1.0);\n	vec4 i2 = clamp(i0 - 1.0, 0.0, 1.0);\n	vec4 i1 = clamp(i0 - 2.0, 0.0, 1.0);\n\n	vec4 x1 = x0 - i1 + C.xxxx;\n	vec4 x2 = x0 - i2 + C.yyyy;\n	vec4 x3 = x0 - i3 + C.zzzz;\n	vec4 x4 = x0 + C.wwww;\n\n	i = mod289(i);\n	float j0 = permute(permute(permute(permute(i.w) + i.z) + i.y) + i.x);\n	vec4 j1 = permute(permute(permute(permute (\n					i.w + vec4(i1.w, i2.w, i3.w, 1.0))\n					+ i.z + vec4(i1.z, i2.z, i3.z, 1.0))\n					+ i.y + vec4(i1.y, i2.y, i3.y, 1.0))\n					+ i.x + vec4(i1.x, i2.x, i3.x, 1.0));\n\n	vec4 ip = vec4(1.0/294.0, 1.0/49.0, 1.0/7.0, 0.0) ;\n\n	vec4 p0 = grad4(j0, ip);\n	vec4 p1 = grad4(j1.x, ip);\n	vec4 p2 = grad4(j1.y, ip);\n	vec4 p3 = grad4(j1.z, ip);\n	vec4 p4 = grad4(j1.w, ip);\n\n	vec4 norm = taylorInvSqrt(vec4(dot(p0, p0), dot(p1, p1), dot(p2, p2), dot(p3, p3)));\n	p0 *= norm.x;\n	p1 *= norm.y;\n	p2 *= norm.z;\n	p3 *= norm.w;\n	p4 *= taylorInvSqrt(dot(p4, p4));\n\n	vec3 m0 = max(0.6 - vec3(dot(x0, x0), dot(x1, x1), dot(x2, x2)), 0.0);\n	vec2 m1 = max(0.6 - vec2(dot(x3, x3), dot(x4, x4)), 0.0);\n	m0 = m0 * m0;\n	m1 = m1 * m1;\n	return 49.0 * (dot(m0*m0, vec3(dot(p0, x0), dot(p1, x1), dot(p2, x2)))\n							+ dot(m1*m1, vec2(dot(p3, x3), dot(p4, x4)))) ;\n}\n#endif\n",Z});